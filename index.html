<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>用户登录 | 任务管理应用</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              neutral: {
                100: "#F3F4F6",
                200: "#E5E7EB",
                300: "#D1D5DB",
                600: "#4B5563",
                700: "#374151",
                800: "#1F2937",
              },
            },
            fontFamily: { inter: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>

    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .transition-custom {
          transition: all 0.3s ease;
        }
      }
    </style>
  </head>
  <body
    class="font-inter bg-gray-50 min-h-screen flex items-center justify-center p-4"
  >
    <!-- 登录/注册容器 -->
    <div class="w-full max-w-md">
      <!-- 应用标题 -->
      <div class="text-center mb-8">
        <div class="flex items-center justify-center space-x-2 mb-2">
          <i class="fa fa-tasks text-primary text-3xl"></i>
          <h1 class="text-2xl font-bold text-neutral-800">任务管理</h1>
        </div>
        <p class="text-neutral-600">高效管理你的日常任务</p>
      </div>

      <!-- 登录表单 -->
      <div id="loginForm" class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold text-neutral-800">用户登录</h2>
          <p class="text-neutral-600 mt-1">请输入账号信息登录</p>
        </div>

        <form id="loginFormElement" class="space-y-4">
          <div>
            <label
              for="loginUsername"
              class="block text-sm font-medium text-neutral-700 mb-1"
              >用户名</label
            >
            <input
              type="text"
              id="loginUsername"
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
              required
            />
          </div>

          <div>
            <label
              for="loginPassword"
              class="block text-sm font-medium text-neutral-700 mb-1"
              >密码</label
            >
            <input
              type="password"
              id="loginPassword"
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
              required
            />
          </div>

          <div class="pt-2">
            <button
              type="submit"
              class="w-full bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium transition-custom"
            >
              登录
            </button>
          </div>
        </form>

        <div class="mt-4 text-center text-neutral-600 text-sm">
          还没有账号？
          <button
            id="switchToRegister"
            class="text-primary font-medium hover:underline"
          >
            立即注册
          </button>
        </div>
      </div>

      <!-- 注册表单 -->
      <div
        id="registerForm"
        class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8"
      >
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold text-neutral-800">用户注册</h2>
          <p class="text-neutral-600 mt-1">创建账号，开始管理你的任务</p>
        </div>

        <form id="registerFormElement" class="space-y-4">
          <div>
            <label
              for="registerUsername"
              class="block text-sm font-medium text-neutral-700 mb-1"
              >用户名</label
            >
            <input
              type="text"
              id="registerUsername"
              minlength="3"
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
              required
            />
            <p class="text-xs text-neutral-500 mt-1">至少3个字符</p>
          </div>

          <div>
            <label
              for="registerPassword"
              class="block text-sm font-medium text-neutral-700 mb-1"
              >密码</label
            >
            <input
              type="password"
              id="registerPassword"
              minlength="6"
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
              required
            />
            <p class="text-xs text-neutral-500 mt-1">至少6个字符</p>
          </div>

          <div class="pt-2">
            <button
              type="submit"
              class="w-full bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium transition-custom"
            >
              注册
            </button>
          </div>
        </form>

        <div class="mt-4 text-center text-neutral-600 text-sm">
          已有账号？
          <button
            id="switchToLogin"
            class="text-primary font-medium hover:underline"
          >
            立即登录
          </button>
        </div>
      </div>
    </div>

    <!-- 通知提示组件 -->
    <div
      id="notification"
      class="fixed top-4 right-4 max-w-xs p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50"
    ></div>

    <script>
      // API基础URL
      const API_BASE_URL = "https://192.168.1.200:3000/api";

      // DOM元素
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const loginFormElement = document.getElementById("loginFormElement");
      const registerFormElement = document.getElementById(
        "registerFormElement"
      );
      const switchToRegister = document.getElementById("switchToRegister");
      const switchToLogin = document.getElementById("switchToLogin");
      const notificationEl = document.getElementById("notification");

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        // 检查是否已登录，如已登录直接跳转
        const token = localStorage.getItem("token");
        if (token) {
          window.location.href = "todo-tasks.html";
        }

        // 绑定事件
        bindEventListeners();
      });

      // 绑定事件
      function bindEventListeners() {
        switchToRegister.addEventListener("click", showRegisterForm);
        switchToLogin.addEventListener("click", showLoginForm);
        loginFormElement.addEventListener("submit", handleLogin);
        registerFormElement.addEventListener("submit", handleRegister);
      }

      // 显示注册表单
      function showRegisterForm() {
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
        document.getElementById("registerUsername").focus();
      }

      // 显示登录表单
      function showLoginForm() {
        registerForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
        document.getElementById("loginUsername").focus();
      }

      // 处理登录
      async function handleLogin(e) {
        e.preventDefault();

        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;

        try {
          const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "登录失败");
          }

          // 保存token
          localStorage.setItem("token", data.token);

          // 登录成功，跳转到任务页面
          window.location.href = "todo-tasks.html";
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      // 处理注册
      async function handleRegister(e) {
        e.preventDefault();

        const username = document
          .getElementById("registerUsername")
          .value.trim();
        const password = document.getElementById("registerPassword").value;

        try {
          const response = await fetch(`${API_BASE_URL}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "注册失败");
          }

          showNotification("注册成功，请登录", "success");
          showLoginForm();
          registerFormElement.reset();
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      // 显示通知
      function showNotification(message, type = "info") {
        notificationEl.className =
          "fixed top-4 right-4 max-w-xs p-4 rounded-lg shadow-lg transform transition-transform duration-300 z-50";

        switch (type) {
          case "success":
            notificationEl.classList.add(
              "bg-green-50",
              "text-green-800",
              "border-l-4",
              "border-green-400"
            );
            notificationEl.innerHTML = `<div class="flex"><i class="fa fa-check-circle text-green-500 mr-2"></i><p>${message}</p></div>`;
            break;
          case "error":
            notificationEl.classList.add(
              "bg-red-50",
              "text-red-800",
              "border-l-4",
              "border-red-400"
            );
            notificationEl.innerHTML = `<div class="flex"><i class="fa fa-times-circle text-red-500 mr-2"></i><p>${message}</p></div>`;
            break;
          default:
            notificationEl.classList.add(
              "bg-blue-50",
              "text-blue-800",
              "border-l-4",
              "border-blue-400"
            );
            notificationEl.innerHTML = `<div class="flex"><i class="fa fa-info-circle text-blue-500 mr-2"></i><p>${message}</p></div>`;
        }

        notificationEl.classList.remove("translate-x-full");
        setTimeout(
          () => notificationEl.classList.add("translate-x-full"),
          3000
        );
      }
    </script>
  </body>
</html>
