<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>任务管理 | 我的任务</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#10B981",
              danger: "#EF4444",
              neutral: {
                100: "#F3F4F6",
                200: "#E5E7EB",
                300: "#D1D5DB",
                600: "#4B5563",
                700: "#374151",
                800: "#1F2937",
              },
            },
            fontFamily: { inter: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>

    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .transition-custom {
          transition: all 0.3s ease;
        }
      }
    </style>
  </head>
  <body class="font-inter bg-gray-50 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
      <div
        class="container mx-auto px-4 py-4 flex justify-between items-center"
      >
        <div class="flex items-center space-x-2">
          <i class="fa fa-tasks text-primary text-2xl"></i>
          <h1 class="text-xl font-bold text-neutral-800">任务管理</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="userMenu" class="flex items-center space-x-4">
            <span
              id="usernameDisplay"
              class="text-neutral-700 font-medium"
            ></span>
            <button
              id="logoutBtn"
              class="p-2 rounded-full hover:bg-neutral-100 transition-custom"
            >
              <i class="fa fa-sign-out text-neutral-600"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6 md:py-10 max-w-4xl">
      <!-- 添加新任务 -->
      <div
        class="bg-white rounded-xl shadow p-4 md:p-6 mb-8 hover:shadow-md transition-custom"
      >
        <h2 class="text-lg font-semibold text-neutral-800 mb-4">添加新任务</h2>
        <form id="addTaskForm" class="flex flex-col sm:flex-row gap-3">
          <input
            type="text"
            id="newTaskTitle"
            placeholder="输入任务内容..."
            class="flex-grow px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
            required
          />
          <button
            type="submit"
            class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-custom"
          >
            <i class="fa fa-plus"></i>
            <span>添加任务</span>
          </button>
        </form>
      </div>

      <!-- 任务过滤和操作 -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"
      >
        <h2 class="text-lg font-semibold text-neutral-800">任务列表</h2>
        <div class="flex flex-wrap gap-2 w-full sm:w-auto">
          <button
            class="filter-btn active px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium transition-custom"
            data-filter="all"
          >
            全部
          </button>
          <button
            class="filter-btn px-4 py-2 rounded-lg bg-neutral-200 text-neutral-700 text-sm font-medium hover:bg-neutral-300 transition-custom"
            data-filter="active"
          >
            待完成
          </button>
          <button
            class="filter-btn px-4 py-2 rounded-lg bg-neutral-200 text-neutral-700 text-sm font-medium hover:bg-neutral-300 transition-custom"
            data-filter="completed"
          >
            已完成
          </button>
          <button
            id="clearCompleted"
            class="px-4 py-2 rounded-lg bg-neutral-200 text-neutral-700 text-sm font-medium hover:bg-danger hover:text-white transition-custom"
          >
            <i class="fa fa-trash-o mr-1"></i>清除已完成
          </button>
        </div>
      </div>

      <!-- 任务列表容器 -->
      <div id="taskList" class="space-y-3 mb-8">
        <!-- 加载状态 -->
        <div
          id="loadingState"
          class="bg-white rounded-xl shadow p-8 text-center"
        >
          <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-4"
          ></div>
          <p class="text-neutral-600">加载任务中...</p>
        </div>

        <!-- 空状态 -->
        <div
          id="emptyState"
          class="hidden bg-white rounded-xl shadow p-8 text-center"
        >
          <i class="fa fa-check-circle-o text-5xl text-neutral-300 mb-4"></i>
          <h3 class="text-lg font-medium text-neutral-800 mb-2">暂无任务</h3>
          <p class="text-neutral-600">添加你的第一个任务，开始高效管理吧！</p>
        </div>
      </div>

      <!-- 移动端统计信息 -->
      <div class="md:hidden bg-white rounded-xl shadow p-4 text-center">
        <p class="text-neutral-600">
          <span id="mobilePendingCount">0</span> 个待完成 /
          <span id="mobileTotalCount">0</span> 个任务总数
        </p>
      </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-neutral-200 py-6 mt-auto">
      <div class="container mx-auto px-4 text-center text-neutral-600 text-sm">
        <p>任务管理应用 &copy; 2023</p>
      </div>
    </footer>

    <!-- 编辑任务模态框 -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 transform translate-y-8 transition-transform duration-300"
      >
        <div class="p-6 border-b border-neutral-200">
          <h3 class="text-xl font-semibold text-neutral-800">编辑任务</h3>
        </div>
        <form id="editTaskForm" class="p-6">
          <input
            type="text"
            id="editTaskTitle"
            class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom mb-4"
            required
          />
          <input type="hidden" id="editTaskId" />
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="cancelEdit"
              class="px-4 py-2 rounded-lg border border-neutral-300 text-neutral-700 hover:bg-neutral-100 transition-custom"
            >
              取消
            </button>
            <button
              type="submit"
              class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-custom"
            >
              保存修改
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 通知提示组件 -->
    <div
      id="notification"
      class="fixed top-4 right-4 max-w-xs p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50"
    ></div>

    <script>
      // API基础URL
      const API_BASE_URL = "http://192.168.1.200:3000/api";

      // 状态管理
      let tasks = [];
      let currentFilter = "all";
      let currentUser = null;

      // DOM元素
      const taskListEl = document.getElementById("taskList");
      const addTaskForm = document.getElementById("addTaskForm");
      const newTaskTitleInput = document.getElementById("newTaskTitle");
      const loadingState = document.getElementById("loadingState");
      const emptyState = document.getElementById("emptyState");
      const filterBtns = document.querySelectorAll(".filter-btn");
      const clearCompletedBtn = document.getElementById("clearCompleted");
      const mobilePendingCountEl =
        document.getElementById("mobilePendingCount");
      const mobileTotalCountEl = document.getElementById("mobileTotalCount");
      const usernameDisplay = document.getElementById("usernameDisplay");
      const logoutBtn = document.getElementById("logoutBtn");

      // 编辑模态框
      const editModal = document.getElementById("editModal");
      const editTaskForm = document.getElementById("editTaskForm");
      const editTaskTitleInput = document.getElementById("editTaskTitle");
      const editTaskIdInput = document.getElementById("editTaskId");
      const cancelEditBtn = document.getElementById("cancelEdit");

      // 通知组件
      const notificationEl = document.getElementById("notification");

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        // 检查登录状态
        const token = localStorage.getItem("token");
        if (!token) {
          // 未登录，跳转回登录页
          window.location.href = "index.html";
          return;
        }

        // 验证token并加载用户信息
        verifyTokenAndLoadUser(token);

        // 绑定事件
        bindEventListeners();
      });

      // 绑定事件
      function bindEventListeners() {
        addTaskForm.addEventListener("submit", handleAddTask);
        clearCompletedBtn.addEventListener("click", handleClearCompleted);
        filterBtns.forEach((btn) =>
          btn.addEventListener("click", handleFilterChange)
        );
        editTaskForm.addEventListener("submit", handleEditTaskSubmit);
        cancelEditBtn.addEventListener("click", hideEditModal);
        logoutBtn.addEventListener("click", handleLogout);
      }

      // 验证token并加载用户
      async function verifyTokenAndLoadUser(token) {
        try {
          const response = await fetch(`${API_BASE_URL}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error("登录已过期，请重新登录");
          }

          const data = await response.json();
          currentUser = data.user;
          usernameDisplay.textContent = currentUser.username;

          // 加载任务
          fetchTasks();
        } catch (error) {
          localStorage.removeItem("token");
          window.location.href = "index.html";
          showNotification(error.message, "error");
        }
      }

      // 获取任务列表
      async function fetchTasks() {
        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          showLoading();

          const response = await fetch(`${API_BASE_URL}/todos`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error("获取任务失败");
          }

          tasks = await response.json();
          renderTasks();
          updateTaskStats();
        } catch (error) {
          showNotification(error.message, "error");
        } finally {
          hideLoading();
        }
      }

      // 渲染任务列表
      function renderTasks() {
        taskListEl.innerHTML = "";

        // 筛选任务
        let filteredTasks = tasks;
        if (currentFilter === "active") {
          filteredTasks = tasks.filter((task) => !task.completed);
        } else if (currentFilter === "completed") {
          filteredTasks = tasks.filter((task) => task.completed);
        }

        // 显示空状态
        if (filteredTasks.length === 0) {
          emptyState.classList.remove("hidden");
          return;
        }
        emptyState.classList.add("hidden");

        // 创建任务项
        filteredTasks.forEach((task) => {
          const formattedDate = new Date(task.created_at).toLocaleString(
            "zh-CN",
            {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            }
          );

          const taskEl = document.createElement("div");
          taskEl.className = `bg-white rounded-xl shadow p-4 hover:shadow-md transition-custom ${
            task.completed ? "opacity-80" : ""
          }`;
          taskEl.dataset.id = task.id;

          taskEl.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex-1 flex items-start gap-3">
              <div class="mt-0.5">
                <input 
                  type="checkbox" 
                  class="task-checkbox w-5 h-5 rounded-full border-2 ${
                    task.completed
                      ? "border-secondary bg-secondary"
                      : "border-neutral-300"
                  } text-white focus:ring-primary/50 cursor-pointer"
                  ${task.completed ? "checked" : ""}
                  data-id="${task.id}"
                >
              </div>
              <div>
                <p class="task-title text-neutral-800 ${
                  task.completed ? "line-through text-neutral-500" : ""
                }">
                  ${escapeHtml(task.title)}
                </p>
                <p class="text-xs text-neutral-500 mt-1">
                  创建于: ${formattedDate}
                </p>
              </div>
            </div>
            <div class="flex gap-2 ml-4">
              <button class="edit-task p-2 text-neutral-500 hover:text-primary rounded-full hover:bg-neutral-100 transition-custom" data-id="${
                task.id
              }">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="delete-task p-2 text-neutral-500 hover:text-danger rounded-full hover:bg-neutral-100 transition-custom" data-id="${
                task.id
              }">
                <i class="fa fa-trash-o"></i>
              </button>
            </div>
          </div>
        `;

          taskListEl.appendChild(taskEl);

          // 绑定事件
          taskEl
            .querySelector(".task-checkbox")
            .addEventListener("change", handleTaskToggle);
          taskEl
            .querySelector(".edit-task")
            .addEventListener("click", handleEditTask);
          taskEl
            .querySelector(".delete-task")
            .addEventListener("click", handleDeleteTask);
        });
      }

      // 添加任务
      async function handleAddTask(e) {
        e.preventDefault();

        const title = newTaskTitleInput.value.trim();
        if (!title) return;

        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/todos`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ title, completed: false }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "添加任务失败");
          }

          const newTask = await response.json();
          tasks.push(newTask);

          addTaskForm.reset();
          renderTasks();
          updateTaskStats();
          showNotification("任务添加成功", "success");
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      // 切换任务状态
      async function handleTaskToggle(e) {
        const taskId = e.target.dataset.id;
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/todos/${taskId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ completed: !task.completed }),
          });

          if (!response.ok) {
            throw new Error("更新任务失败");
          }

          const updatedTask = await response.json();
          const index = tasks.findIndex((t) => t.id === taskId);
          if (index !== -1) tasks[index] = updatedTask;

          renderTasks();
          updateTaskStats();
        } catch (error) {
          e.target.checked = !e.target.checked; // 恢复状态
          showNotification(error.message, "error");
        }
      }

      // 编辑任务
      function handleEditTask(e) {
        const taskId = e.target.closest(".edit-task").dataset.id;
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        editTaskIdInput.value = task.id;
        editTaskTitleInput.value = task.title;
        showEditModal();
      }

      // 提交编辑
      async function handleEditTaskSubmit(e) {
        e.preventDefault();

        const taskId = editTaskIdInput.value;
        const title = editTaskTitleInput.value.trim();
        if (!taskId || !title) return;

        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/todos/${taskId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ title }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "更新任务失败");
          }

          const updatedTask = await response.json();
          const index = tasks.findIndex((t) => t.id === taskId);
          if (index !== -1) tasks[index] = updatedTask;

          hideEditModal();
          renderTasks();
          showNotification("任务更新成功", "success");
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      // 删除任务
      async function handleDeleteTask(e) {
        const taskId = e.target.closest(".delete-task").dataset.id;
        if (!confirm("确定要删除这个任务吗？")) return;

        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/todos/${taskId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error("删除任务失败");
          }

          tasks = tasks.filter((task) => task.id !== taskId);
          renderTasks();
          updateTaskStats();
          showNotification("任务已删除", "success");
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      // 清除已完成任务
      async function handleClearCompleted() {
        const completedTasks = tasks.filter((task) => task.completed);
        if (completedTasks.length === 0) {
          showNotification("没有已完成的任务", "info");
          return;
        }

        if (
          !confirm(`确定要删除这 ${completedTasks.length} 个已完成的任务吗？`)
        )
          return;

        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          for (const task of completedTasks) {
            await fetch(`${API_BASE_URL}/todos/${task.id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
          }

          tasks = tasks.filter((task) => !task.completed);
          renderTasks();
          updateTaskStats();
          showNotification("已完成任务已清除", "success");
        } catch (error) {
          showNotification(error.message, "error");
          fetchTasks(); // 重新加载任务列表保持同步
        }
      }

      // 切换筛选条件
      function handleFilterChange(e) {
        const filter = e.target.dataset.filter;
        if (!filter || filter === currentFilter) return;

        currentFilter = filter;

        // 更新按钮样式
        filterBtns.forEach((btn) => {
          if (btn.dataset.filter === filter) {
            btn.classList.remove(
              "bg-neutral-200",
              "text-neutral-700",
              "hover:bg-neutral-300"
            );
            btn.classList.add("bg-primary", "text-white");
          } else {
            btn.classList.remove("bg-primary", "text-white");
            btn.classList.add(
              "bg-neutral-200",
              "text-neutral-700",
              "hover:bg-neutral-300"
            );
          }
        });

        renderTasks();
      }

      // 更新任务统计
      function updateTaskStats() {
        const total = tasks.length;
        const pending = tasks.filter((task) => !task.completed).length;

        mobilePendingCountEl.textContent = pending;
        mobileTotalCountEl.textContent = total;
      }

      // 显示编辑模态框
      function showEditModal() {
        editModal.classList.remove("hidden");
        setTimeout(() => {
          editModal.classList.add("opacity-100");
          editModal.querySelector("div").classList.remove("translate-y-8");
          editModal.querySelector("div").classList.add("translate-y-0");
        }, 10);
        editTaskTitleInput.focus();
      }

      // 隐藏编辑模态框
      function hideEditModal() {
        editModal.classList.remove("opacity-100");
        editModal.querySelector("div").classList.remove("translate-y-0");
        editModal.querySelector("div").classList.add("translate-y-8");

        setTimeout(() => {
          editModal.classList.add("hidden");
          editTaskForm.reset();
        }, 300);
      }

      // 处理登出
      function handleLogout() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
        showNotification("已成功登出", "info");
      }

      // 显示通知
      function showNotification(message, type = "info") {
        notificationEl.className =
          "fixed top-4 right-4 max-w-xs p-4 rounded-lg shadow-lg transform transition-transform duration-300 z-50";

        switch (type) {
          case "success":
            notificationEl.classList.add(
              "bg-green-50",
              "text-green-800",
              "border-l-4",
              "border-green-400"
            );
            notificationEl.innerHTML = `<div class="flex"><i class="fa fa-check-circle text-green-500 mr-2"></i><p>${message}</p></div>`;
            break;
          case "error":
            notificationEl.classList.add(
              "bg-red-50",
              "text-red-800",
              "border-l-4",
              "border-red-400"
            );
            notificationEl.innerHTML = `<div class="flex"><i class="fa fa-times-circle text-red-500 mr-2"></i><p>${message}</p></div>`;
            break;
          default:
            notificationEl.classList.add(
              "bg-blue-50",
              "text-blue-800",
              "border-l-4",
              "border-blue-400"
            );
            notificationEl.innerHTML = `<div class="flex"><i class="fa fa-info-circle text-blue-500 mr-2"></i><p>${message}</p></div>`;
        }

        notificationEl.classList.remove("translate-x-full");
        setTimeout(
          () => notificationEl.classList.add("translate-x-full"),
          3000
        );
      }

      // 显示加载状态
      function showLoading() {
        loadingState.classList.remove("hidden");
        emptyState.classList.add("hidden");
      }

      // 隐藏加载状态
      function hideLoading() {
        loadingState.classList.add("hidden");
      }

      // 转义HTML特殊字符
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>
